<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë§¤ì¶œ í˜„í™© | ì¼ë ‰íŠ¸ë¦¬</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="sales-container">

        <h2 id="titleText">ë§¤ì¶œ í˜„í™©</h2>

        <!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œ ë°•ìŠ¤ -->
        <div class="summary-box">
            <h3>ì´ë²ˆ ë‹¬ ë§¤ì¶œ</h3>
            <p id="monthSales">0 ì›</p>
        </div>

        <!-- ë§¤ì¶œ ë‚´ì—­ -->
        <div class="table-box">
            <h3>ë§¤ì¶œ ë‚´ì—­</h3>
            <table>
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ìˆ˜ì—…</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì…ê¸ˆ í™•ì¸</th>
                    </tr>
                </thead>
                <tbody id="salesTable"></tbody>
            </table>
        </div>

        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    </div>


<script>
/* ===========================================================
    ğŸ”¥ ì „ì—­ ë³€ìˆ˜ (í˜„ì¬ ê°•ì‚¬ ì €ì¥ â†’ ì‹¤ì‹œê°„ ê³„ì‚°ìš©)
=========================================================== */
let CURRENT_TEACHER = null;

/* ===========================================================
    ë”ë¯¸ ë§¤ì¶œ ë°ì´í„°
=========================================================== */
const SALES_DATA = {
    "ê°•ì‚¬A": [
        { id: "A1", date: "2025-11-05", class: "ê¸°ë³¸ PT", price: 50000 },
        { id: "A2", date: "2025-11-10", class: "ì¬ë“±ë¡ PT", price: 150000 },
        { id: "A3", date: "2025-11-12", class: "ìƒë‹´", price: 30000 }
    ],
    "ê°•ì‚¬B": [
        { id: "B1", date: "2025-11-03", class: "ê¸°ë³¸ PT", price: 60000 },
        { id: "B2", date: "2025-11-11", class: "ì¬ë“±ë¡ PT", price: 120000 }
    ]
};


/* ===========================================================
    í˜ì´ì§€ ì ‘ê·¼ ì²´í¬
=========================================================== */
window.onload = function () {

    const user = JSON.parse(sessionStorage.getItem("loggedInUser")) ||
                 JSON.parse(localStorage.getItem("loggedInUser"));

    if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
        window.location.href = "login.html";
        return;
    }

    // ê´€ë¦¬ì ì ‘ê·¼ ê°€ëŠ¥
    if (user.role === "admin") {
        loadSales("ê°•ì‚¬A");
        return;
    }

    // ê°•ì‚¬ ë³¸ì¸ í™•ì¸
    const teacher = new URLSearchParams(window.location.search).get("instructor");

    if (!teacher || teacher !== user.id) {
        alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
        window.location.href = "login.html";
        return;
    }

    loadSales(teacher);
};


/* ===========================================================
    ë§¤ì¶œ ë¡œë”© + ì²´í¬ë°•ìŠ¤ ë°˜ì˜ ë¡œì§
=========================================================== */
function loadSales(teacher) {

    // â­ í˜„ì¬ ê°•ì‚¬ ì €ì¥ â†’ ì‹¤ì‹œê°„ ê³„ì‚°ì—ì„œ ì‚¬ìš©ë¨
    CURRENT_TEACHER = teacher;

    document.getElementById("titleText").textContent =
        `${teacher}ë‹˜ì˜ ë§¤ì¶œ í˜„í™©`;

    const month = new Date().getMonth() + 1;
    const list = SALES_DATA[teacher] || [];
    const table = document.getElementById("salesTable");
    table.innerHTML = "";

    let monthTotal = 0;

    list.forEach(v => {
        const isThisMonth = parseInt(v.date.substring(5, 7)) === month;

        const checked = localStorage.getItem(`paid_${v.id}`) === "true";

        if (isThisMonth && checked) monthTotal += v.price;

        table.innerHTML += `
            <tr>
                <td>${v.date}</td>
                <td>${v.class}</td>
                <td>${v.price.toLocaleString()} ì›</td>
                <td>
                    <input type="checkbox"
                           class="paid-check"
                           data-id="${v.id}"
                           ${checked ? "checked" : ""}>
                </td>
            </tr>
        `;
    });

    document.getElementById("monthSales").textContent =
        monthTotal.toLocaleString() + " ì›";

    // ğŸ”¥ ì²´í¬ë°•ìŠ¤(ì…ê¸ˆ í™•ì¸) í´ë¦­ â†’ ì‹¤ì‹œê°„ ê³„ì‚°
    document.querySelectorAll(".paid-check").forEach(chk => {
        chk.addEventListener("change", function () {

            const id = this.getAttribute("data-id");
            localStorage.setItem(`paid_${id}`, this.checked);

            // â­ "teacher" ë‹¤ì‹œ ê³„ì‚° í•¨ìˆ˜ì— ì „ë‹¬í•  í•„ìš” ì—†ìŒ â†’ CURRENT_TEACHER ì‚¬ìš©
            recalcMonthSales();
        });
    });
}


/* ===========================================================
    ì‹¤ì‹œê°„ ì´ë²ˆ ë‹¬ ë§¤ì¶œ ì¬ê³„ì‚° (í…Œì´ë¸” ë‹¤ì‹œ ì•ˆ ë§Œë“¦)
=========================================================== */
function recalcMonthSales() {

    const teacher = CURRENT_TEACHER;  // â­ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©!
    const month = new Date().getMonth() + 1;
    const list = SALES_DATA[teacher] || [];

    let total = 0;

    list.forEach(v => {
        const isThisMonth = parseInt(v.date.substring(5, 7)) === month;
        const checked = localStorage.getItem(`paid_${v.id}`) === "true";

        if (isThisMonth && checked) total += v.price;
    });

    document.getElementById("monthSales").textContent =
        total.toLocaleString() + " ì›";
}


/* ===========================================================
    ë¡œê·¸ì•„ì›ƒ
=========================================================== */
function logout() {
    sessionStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
}
</script>


</body>
</html>
