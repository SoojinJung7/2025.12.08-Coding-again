<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë§¤ì¶œ í˜„í™© | ì¼ë ‰íŠ¸ë¦¬</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="sales-container">

        <h2 id="titleText">ë§¤ì¶œ í˜„í™©</h2>

        <!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œ ë°•ìŠ¤ -->
        <div class="summary-box">
            <h3>ì´ë²ˆ ë‹¬ ë§¤ì¶œ</h3>
            <p id="monthSales">0 ì›</p>
        </div>

        <!-- ë§¤ì¶œ ë‚´ì—­ -->
       <!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œ (í…Œì´ë¸”/ì—†ìŒ ë¬¸êµ¬ ì˜ì—­) -->
<div class="table-box">
    <h3>ì´ë²ˆ ë‹¬ ë§¤ì¶œ ë‚´ì—­</h3>

    <!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œì´ ì—†ì„ ë•Œ í‘œì‹œ -->
    <p id="thisMonthEmpty" class="empty-msg" style="display:none;">
        ì´ë²ˆ ë‹¬ ë§¤ì¶œì€ ì—†ìŠµë‹ˆë‹¤
    </p>

    <!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œì´ ìˆì„ ë•Œë§Œ í…Œì´ë¸” í‘œì‹œ -->
    <table id="thisMonthTable" style="display:none;">
        <thead>
            <tr>
                <th>ë‚ ì§œ</th>
                <th>ìˆ˜ì—…</th>
                <th>ê¸ˆì•¡</th>
                <th>ì…ê¸ˆ í™•ì¸</th>
            </tr>
        </thead>
        <tbody id="thisMonthBody"></tbody>
    </table>
</div>

<!-- ì§€ë‚œ ë‹¬ ë§¤ì¶œ (í† ê¸€) -->
<div class="table-box">
    <button type="button" class="toggle-btn" id="lastMonthToggle" aria-expanded="false">
        ì§€ë‚œ ë‹¬ì˜ ë§¤ì¶œ <span id="toggleIcon">â–¾</span>
    </button>

    <div id="lastMonthPanel" style="display:none; margin-top:12px;">
        <p id="lastMonthEmpty" class="empty-msg" style="display:none;">
            ì§€ë‚œ ë‹¬ ë§¤ì¶œì€ ì—†ìŠµë‹ˆë‹¤
        </p>

        <table id="lastMonthTable" style="display:none;">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ìˆ˜ì—…</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì…ê¸ˆ í™•ì¸</th>
                </tr>
            </thead>
            <tbody id="lastMonthBody"></tbody>
        </table>
    </div>
</div>



<script>
/* ===========================================================
    ğŸ”¥ ì „ì—­ ë³€ìˆ˜ (í˜„ì¬ ê°•ì‚¬ ì €ì¥ â†’ ì‹¤ì‹œê°„ ê³„ì‚°ìš©)
=========================================================== */
let CURRENT_TEACHER = null;

/* ===========================================================
    ë”ë¯¸ ë§¤ì¶œ ë°ì´í„°
=========================================================== */
const SALES_DATA = {
    "ê°•ì‚¬A": [
        { id: "A1", date: "2025-11-05", class: "ê¸°ë³¸ PT", price: 50000 },
        { id: "A2", date: "2025-11-10", class: "ì¬ë“±ë¡ PT", price: 150000 },
        { id: "A3", date: "2025-11-12", class: "ìƒë‹´", price: 30000 }
    ],
    "ê°•ì‚¬B": [
        { id: "B1", date: "2025-11-03", class: "ê¸°ë³¸ PT", price: 60000 },
        { id: "B2", date: "2025-11-11", class: "ì¬ë“±ë¡ PT", price: 120000 }
    ]
};


/* ===========================================================
    í˜ì´ì§€ ì ‘ê·¼ ì²´í¬
=========================================================== */
window.onload = function () {

    const user = JSON.parse(sessionStorage.getItem("loggedInUser")) ||
                 JSON.parse(localStorage.getItem("loggedInUser"));

    if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
        window.location.href = "login.html";
        return;
    }

    // ê´€ë¦¬ì ì ‘ê·¼ ê°€ëŠ¥
    if (user.role === "admin") {
        loadSales("ê°•ì‚¬A");
        return;
    }

    // ê°•ì‚¬ ë³¸ì¸ í™•ì¸
    const teacher = new URLSearchParams(window.location.search).get("instructor");

    if (!teacher || teacher !== user.id) {
        alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
        window.location.href = "login.html";
        return;
    }

    loadSales(teacher);
};

// ì§€ë‚œ ë‹¬ í† ê¸€
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("lastMonthToggle");
    const panel = document.getElementById("lastMonthPanel");
    const icon = document.getElementById("toggleIcon");

    if (!btn || !panel || !icon) return;

    btn.addEventListener("click", () => {
        const isOpen = btn.getAttribute("aria-expanded") === "true";
        btn.setAttribute("aria-expanded", String(!isOpen));
        panel.style.display = isOpen ? "none" : "block";
        icon.textContent = isOpen ? "â–¾" : "â–´";
    });
});




/* ===========================================================
    ë§¤ì¶œ ë¡œë”© + ì²´í¬ë°•ìŠ¤ ë°˜ì˜ ë¡œì§
=========================================================== */
function loadSales(teacher) {
    CURRENT_TEACHER = teacher;

    document.getElementById("titleText").textContent =
        `${teacher}ë‹˜ì˜ ë§¤ì¶œ í˜„í™©`;

    const now = new Date();
    const thisMonth = now.getMonth() + 1;

    const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const lastMonth = lastMonthDate.getMonth() + 1;
    const lastMonthYear = lastMonthDate.getFullYear();

    const list = SALES_DATA[teacher] || [];

    // DOM
    const thisMonthBody = document.getElementById("thisMonthBody");
    const lastMonthBody = document.getElementById("lastMonthBody");

    const thisMonthTable = document.getElementById("thisMonthTable");
    const lastMonthTable = document.getElementById("lastMonthTable");

    const thisMonthEmpty = document.getElementById("thisMonthEmpty");
    const lastMonthEmpty = document.getElementById("lastMonthEmpty");

    // ì´ˆê¸°í™”
    thisMonthBody.innerHTML = "";
    lastMonthBody.innerHTML = "";

    let thisMonthRowsCount = 0;
    let lastMonthRowsCount = 0;
    let monthTotal = 0; // "ì´ë²ˆ ë‹¬ ë§¤ì¶œ(ì…ê¸ˆ í™•ì¸ ì²´í¬ëœ ê²ƒë§Œ)" í•©ê³„

    list.forEach(v => {
        const year = parseInt(v.date.substring(0, 4), 10);
        const month = parseInt(v.date.substring(5, 7), 10);

        const checked = localStorage.getItem(`paid_${v.id}`) === "true";

        // ì´ë²ˆ ë‹¬ / ì§€ë‚œ ë‹¬ íŒë³„
        const isThisMonth = (month === thisMonth && year === now.getFullYear());
        const isLastMonth = (month === lastMonth && year === lastMonthYear);

        // ì´ë²ˆ ë‹¬ ë§¤ì¶œ í•©ê³„(ì…ê¸ˆ í™•ì¸ëœ ê²ƒë§Œ)
        if (isThisMonth && checked) monthTotal += v.price;

        // ë Œë”ë§ì€ "ì´ë²ˆ ë‹¬ í…Œì´ë¸”" ë˜ëŠ” "ì§€ë‚œ ë‹¬ í…Œì´ë¸”"ë¡œ ë¶„ê¸°
        if (isThisMonth) {
            thisMonthRowsCount++;
            thisMonthBody.innerHTML += `
                <tr>
                    <td>${v.date}</td>
                    <td>${v.class}</td>
                    <td>${v.price.toLocaleString()} ì›</td>
                    <td>
                        <input type="checkbox"
                               class="paid-check"
                               data-id="${v.id}"
                               ${checked ? "checked" : ""}>
                    </td>
                </tr>
            `;
        } else if (isLastMonth) {
            lastMonthRowsCount++;
            lastMonthBody.innerHTML += `
                <tr>
                    <td>${v.date}</td>
                    <td>${v.class}</td>
                    <td>${v.price.toLocaleString()} ì›</td>
                    <td>
                        <input type="checkbox"
                               class="paid-check"
                               data-id="${v.id}"
                               ${checked ? "checked" : ""}>
                    </td>
                </tr>
            `;
        }
    });

    // ì´ë²ˆ ë‹¬: ë°ì´í„° ì—†ìœ¼ë©´ ë¬¸êµ¬, ìˆìœ¼ë©´ í…Œì´ë¸”
    if (thisMonthRowsCount === 0) {
        thisMonthEmpty.style.display = "block";
        thisMonthTable.style.display = "none";
    } else {
        thisMonthEmpty.style.display = "none";
        thisMonthTable.style.display = "table";
    }

    // ì§€ë‚œ ë‹¬: ë°ì´í„° ì—†ìœ¼ë©´ ë¬¸êµ¬, ìˆìœ¼ë©´ í…Œì´ë¸” (ë‹¨, íŒ¨ë„ì€ í† ê¸€ ì—´ì–´ì•¼ ë³´ì„)
    if (lastMonthRowsCount === 0) {
        lastMonthEmpty.style.display = "block";
        lastMonthTable.style.display = "none";
    } else {
        lastMonthEmpty.style.display = "none";
        lastMonthTable.style.display = "table";
    }

    // ì´ë²ˆ ë‹¬ í•©ê³„ í‘œì‹œ
    document.getElementById("monthSales").textContent =
        monthTotal.toLocaleString() + " ì›";

    // ì²´í¬ë°•ìŠ¤(ì…ê¸ˆ í™•ì¸) í´ë¦­ â†’ ì‹¤ì‹œê°„ ê³„ì‚°
    document.querySelectorAll(".paid-check").forEach(chk => {
        chk.addEventListener("change", function () {
            const id = this.getAttribute("data-id");
            localStorage.setItem(`paid_${id}`, this.checked);
            recalcMonthSales(); // ì´ë²ˆ ë‹¬ í•©ê³„ë§Œ ì¬ê³„ì‚°
        });
    });
}



/* ===========================================================
    ì‹¤ì‹œê°„ ì´ë²ˆ ë‹¬ ë§¤ì¶œ ì¬ê³„ì‚° (í…Œì´ë¸” ë‹¤ì‹œ ì•ˆ ë§Œë“¦)
=========================================================== */
function recalcMonthSales() {

    const teacher = CURRENT_TEACHER;  // â­ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©!
    const month = new Date().getMonth() + 1;
    const list = SALES_DATA[teacher] || [];

    let total = 0;

    list.forEach(v => {
        const isThisMonth = parseInt(v.date.substring(5, 7)) === month;
        const checked = localStorage.getItem(`paid_${v.id}`) === "true";

        if (isThisMonth && checked) total += v.price;
    });

    document.getElementById("monthSales").textContent =
        total.toLocaleString() + " ì›";
}


/* ===========================================================
    ë¡œê·¸ì•„ì›ƒ
=========================================================== */
function logout() {
    sessionStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
}
</script>


</body>
</html>

